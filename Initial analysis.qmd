---
title: "Pig handling"
format: pdf
editor: source
editor_options: 
  chunk_output_type: console
---

```{r, echo=F}
knitr::opts_chunk$set(echo = F, warning = F, message = F)
```

```{r}
library(tidyverse)
library(survival)
library(survminer)
```


## For discussion: potential outline of non-spatial analyses

Main things to compare among treatments, excluding spatial behaviour after release:

• Times to events (handling, recovery, total time, etc)

• Adverse outcomes -- injuries, death within 30 days

• Body temperature and hyperthermia

• ...


```{r load data}
x <- read.csv("input/Combined feral pig data_SD_20250328 AB.csv", header = T) %>%
  janitor::clean_names()%>%
  mutate(date = as.POSIXct(date, format = "%d/%m/%Y %H:%M:%S"),
         ambient_temp = as.numeric(ambient_temp),
         temp_body = as.numeric(temp_body),
         hyperthermic = 0) 

x$dose_yohimbine_mg[which(x$dose_yohimbine_mg == "-")] <- ""
x$dose_atipamezole_mg[which(x$dose_atipamezole_mg == "-")] <- ""

x$hyperthermic[which(x$temp_body >=40)] <- 1
x$date[which(x$date == "2023-09-21 00:00:00 AEST")] <- "2023-09-21 06:10:00 AEST"

x$handling_duration_min <- as.numeric(x$handling_duration_min)
x$total_duration_min <- as.numeric(x$total_duration_min)

x$capture_method <- factor(x$capture_method, levels = c("Manual", "Pole syringe", "Darting"))

x <- x %>%
  select(-name, -state, -x, -notes_on_collar_recovery, -fate, -collar_data, 
         -collar_in_hand, -collar_end_date, -tags_in_trap, -last_usable_fix)
```


The range of questions we can answer is limited by the lack of standardised measurements, e.g. no mass for manually restrained pigs.

Also, capture method and drugs are confounded

-   91 manual captures with no drugs

-   155 pole syringe captures with zoletil

-   119 dart captures with zoletil and xylazine (59 atipamezole, 31 yohimbine, 29 without reversal?)


**Q1 Do time to event profiles (survival curves) differ among treatments?**

*Expectation 1.1: Pigs subjected to manual restraint had shorter handling and total time than pigs immobilised with pole syringe or dart.*

Handling time \~ capture method (manual, pole, dart)


```{r handling time by capture method, include = F}
# survival formula
surv.ht <- Surv(time = x$handling_duration_min, event = rep(1, nrow(x)))

# KM survival model
ht1 <- survfit(surv.ht ~ capture_method, data=x)
ht1

surv_median(ht1)

```

Handling time was clearly shorter for pigs subjected to manual handling (median handling time = `r surv_median(ht1)[1,2]` mins, n = `r ht1$n[1]`) than for pigs subjected to immobilisation via pole syringe (median handling time = `r surv_median(ht1)[2,2]`  mins, n = `r ht1$n[2]`), which was clearly shorter than pigs immobilised by darting (median handling time = `r surv_median(ht1)[3,2]` mins, n = `r ht1$n[3]`).    


```{r plot handling time by capture method}
ggsurvplot(ht1, data=x, conf.int = T, 
           palette = "jama",
           legend = "bottom", legend.title = "Capture method",
           legend.labs = c("Manual", "Pole syringe", "Dart"),
           ggtheme = theme_survminer(font.caption = c(10, "plain", "black")))  +
  xlab("Handling time (mins)") +
  ylab("Proportion of pigs") +
  labs(caption = "KM curves: handling time for pigs subjected to different capture methods") 

ht1.median <- as.data.frame(surv_median(ht1)) %>%
  mutate(strata = factor(gsub("capture_method=", "", strata), 
                         levels = c("Manual", "Pole syringe", "Darting")))

ggplot(ht1.median) +
  geom_point(aes(x=strata, y = median)) +
  geom_linerange(aes(x=strata, ymin = lower, ymax = upper)) +
  labs(y = "Median handling time (mins)", x = "Treatment",
       caption = "Median handling time for pigs subjected to different capture methods") +
  theme_classic()

```

Total time \~ capture method

```{r total time, include = F}
# survival formula
surv.tt <- Surv(time = x$total_duration_min, event = rep(1, nrow(x)))

# KM survival model
tt1 <- survfit(surv.tt ~ capture_method, data=x)
tt1

surv_median(tt1)
```

Total time was also shorter for pigs subjected to manual handling (median total time = `r surv_median(tt1)[1,2]` mins, n = `r tt1$n[1]`) than for pigs subjected to pole syringe (median total time = `r surv_median(tt1)[2,2]` mins, n = `r tt1$n[2]`), which was shorter than pigs subjected to darting (median total time = `r surv_median(tt1)[3,2]` mins, n = `r tt1$n[3]`). 

```{r plot capture method TT}
ggsurvplot(tt1, data=x, conf.int = T, 
           palette = "jama",
           legend = "bottom", legend.title = "Capture method",
           legend.labs = c("Manual", "Pole syringe", "Dart"),
           ggtheme = theme_survminer(font.caption = c(10, "plain", "black")))  +
  xlab("Total time (mins)") +
  ylab("Proportion of pigs") +
  labs(caption = "KM curves: total time for pigs subjected to different capture methods")

tt1.median <- as.data.frame(surv_median(tt1)) %>%
  mutate(strata = factor(gsub("capture_method=", "", strata), 
                         levels = c("Manual", "Pole syringe", "Darting")))

ggplot(tt1.median) +
  geom_point(aes(x=strata, y = median)) +
  geom_linerange(aes(x=strata, ymin = lower, ymax = upper)) +
  labs(y = "Median total time (mins)", x = "Treatment",
       caption = "Median total time for pigs subjected to different capture methods") +
  theme_classic()
```

{{< pagebreak >}}

*Expectation 1.2: Pigs subjected to different chemical treatments had different handling and total time.*

Again, there's some confounding here that will have to be woven into the discussion.

Maybe:

Recovery time \~ drug combination (zol, zol xyl, zol xyl + yohimbine, zol xyl + atipamezole?)  

Currently, we only have `recovery time` for pole syringe captures and `reversal time` for dart captures. Are these the same thing?  

Anyway, looking at total time for now...

Total time \~ drug combination (zol, zol xyl, zol xyl + yohimbine, zol xyl + atipamezole?)  


```{r model drug combo tt, include = F}
xd <- x %>% 
  filter(capture_method != "Manual") %>%
  mutate(capture_method = factor(capture_method, levels = c("Pole syringe", "Darting")))

# create categorical variable for drug combination
xd$combo <- NA
xd$combo[which(xd$drug_s == "Zoletil")] <- "Z"
xd$combo[which(xd$drug_s == "Zoletil/Xylazine")] <- "ZX"
xd$combo[which(xd$dose_yohimbine_mg != "")] <- paste0(xd$combo[which(xd$dose_yohimbine_mg != "")], "+Y")
xd$combo[which(xd$dose_atipamezole_mg != "")] <- paste0(xd$combo[which(xd$dose_atipamezole_mg != "")], "+A")
table(xd$combo)

# survival formula
surv.tt.drug <- Surv(time = xd$total_duration_min, event = rep(1, nrow(xd)))

# KM survival model
tt.drug1 <- survfit(surv.tt.drug ~ combo, data=xd)
tt.drug1
``` 

I'm not sure if this is a valid or useful comparison (Jordan?), but pigs treated only with zoletil had shorter total times (median total time = `r surv_median(tt.drug1)[1,2]` mins, n = `r tt.drug1$n[1]`) than pigs treated with zoletil and xylazine. There was no clear difference among the latter group, though there was a tendency for pigs that were not treated with a reversal drug to have shorter total times (median total time = `r surv_median(tt.drug1)[2,2]` mins, n = `r tt.drug1$n[2]`) than those administered atipamezole (median total time = `r surv_median(tt.drug1)[3,2]` mins, n = `r tt.drug1$n[3]`) or yohimbine (median total time = `r surv_median(tt.drug1)[4,2]` mins, n = `r tt.drug1$n[4]`). 

```{r plot drug combo tt}
ggsurvplot(tt.drug1, data=xd, conf.int = T, 
           palette = "jama",
           legend = "bottom", legend.title = "Drug regime",
           legend.labs = c("Z", "Z+X", "Z+X, A", "Z+X, Y"),
           ggtheme = theme_survminer(font.caption = c(10, "plain", "black")))  +
  xlab("Time (mins)") +
  ylab("Proportion of pigs") +
  labs(caption = "KM curves: total time for pigs subjected to different chem immob regimes")
  
tt.drug1.median <- as.data.frame(surv_median(tt.drug1)) %>%
  mutate(strata = gsub("combo=", "", strata))

ggplot(tt.drug1.median) +
  geom_point(aes(x=strata, y = median)) +
  geom_linerange(aes(x=strata, ymin = lower, ymax = upper)) +
  labs(y = "Median total time (mins)", x = "Treatment",
       caption = "Median total time for pigs subjected to different chem immob regimes") +
  theme_classic()

```

Again, the zoletil only treatment is perfectly confounded with pole syringe administration and all darted pigs received xylazine.  

```{r drug confounding}
xd %>% group_by(combo, capture_method) %>%
  summarise(n = n()) %>%
  knitr::kable()
```


**Q2 Did the probability of adverse events differ among capture methods?**

We don't seem to have consistent data for scoring or describing injuries, but we could look at differences in probability of death (from causes other than misadventure) within 30 days.

• Pr(death \<31 days after capture) \~ treatment (± body temp or hyperthermia, total time, recovery duration for immobilised pigs)

**Q3 Did Body temperature and hyperthermia risk differ among treatments?**

I suspect this might depend on when the temperature was taken. For manually restrained pigs, it was taken while the pig was being collared, shortly before release. I presume it was taken during collaring for immobilised pigs, in which case it mightn't be an accurate representation of temperature during prolonged recovery when animals might suffer from poor thermoregulation?

*Expectation 3.1: Average body temperature during handling differed among treatments.*

I don't have a strong prior expectation that any treatment will be 'better' than any other with respect to body temperature during handling.

• Body temp \~ treatment + ambient temp

• Pr(body temp \> 40C) \~ treatment + ambient temp

